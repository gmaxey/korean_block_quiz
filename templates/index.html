<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Korean Block Quiz</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0; /* Remove default body margin */
        }
        .container {
            padding: 10px; /* Reduced from default Bootstrap padding */
            max-width: 100%; /* Use full width */
        }
        .card {
            cursor: pointer;
            margin: 2px; /* Reduced from 5px */
            padding: 5px; /* Reduced from 10px */
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1.1em; /* Slightly smaller for compactness */
            height: 35px; /* Reduced from 40px */
            line-height: 25px; /* Adjusted for new height */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .korean-card {
            width: 60px; /* Kept narrow */
        }
        .english-card, .answer-card {
            width: 400px; /* Doubled from 200px */
            position: relative;
        }
        .english-card:hover::after, .answer-card:hover::after {
            content: attr(data-fulltext); /* Full text on hover */
            position: absolute;
            top: 100%;
            left: 0;
            background: #fff;
            border: 1px solid #ccc;
            padding: 5px;
            z-index: 1000; /* Ensure itâ€™s above other elements */
            white-space: normal; /* Allow wrapping */
            width: auto;
            max-width: 400px; /* Match card width */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* Visual clarity */
        }
        .card.selected {
            border: 2px solid blue;
        }
        .card.matched {
            background-color: #d3d3d3;
            color: #333;
            cursor: default;
        }
        .card.error {
            border: 2px solid red;
            animation: flash 0.5s;
        }
        @keyframes flash {
            0% { border-color: red; }
            50% { border-color: transparent; }
            100% { border-color: red; }
        }
        .card-container {
            display: flex;
            flex-direction: column;
            max-height: 80vh; /* Increased from 70vh */
            overflow-y: auto;
        }
        .reveal-card {
            visibility: hidden;
        }
        .reveal-card.revealed {
            visibility: visible;
        }
        #reveal-btn, #restart-btn {
            margin: 5px; /* Reduced from 10px */
        }
        .controls {
            margin-bottom: 10px; /* Reduced from mb-3 */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center">Korean Block Quiz</h1>
        <div class="text-center controls">
            <label for="slice">Frequency Slice:</label>
            <select id="slice" class="form-select d-inline w-auto">
                <option value="0">1 (Most Frequent)</option>
                <option value="1">2</option>
                <option value="2">3</option>
                <option value="3">4</option>
                <option value="4">5</option>
                <option value="5">6</option>
                <option value="6">7</option>
                <option value="7">8</option>
                <option value="8">9</option>
                <option value="9">10 (Least Frequent)</option>
            </select>
            <button id="restart-btn" class="btn btn-success">Restart</button>
            <button id="reveal-btn" class="btn btn-primary" title="Hold to reveal translations">Reveal</button>
        </div>
        <div class="row">
            <div class="col-md-3">
                <h3>Korean Blocks</h3>
                <div id="korean-cards" class="card-container"></div>
            </div>
            <div class="col-md-4">
                <h3>Answers</h3>
                <div id="answer-cards" class="card-container"></div>
            </div>
            <div class="col-md-5">
                <h3>English Translations</h3>
                <div id="english-cards" class="card-container"></div>
            </div>
        </div>
        <div class="text-center mt-2">
            <p>Score: <span id="score">0</span>/12</p>
            <div id="review" class="mt-2" style="display: none;">
                <h4>Missed Blocks</h4>
                <ul id="missed-list"></ul>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedKorean = null;
        let selectedEnglish = null;
        let correctCount = 0;
        let correctPairs = [];
        let missed = [];

        function loadCards() {
            const slice = document.getElementById('slice').value;
            fetch(`/api/cards?slice=${slice}`)
                .then(response => response.json())
                .then(data => {
                    renderCards('korean-cards', data.korean, 'korean');
                    renderCards('answer-cards', data.ordered_english, 'answer');
                    renderCards('english-cards', data.shuffled_english, 'english');
                    correctCount = 0;
                    correctPairs = [];
                    missed = [];
                    updateScore();
                    document.getElementById('review').style.display = 'none';
                });
        }

        function renderCards(containerId, items, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            items.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = `card ${type}-card`;
                if (type === 'answer') card.classList.add('reveal-card');
                card.textContent = item;
                card.dataset[type] = item;
                card.dataset.fulltext = item; // For hover
                if (type !== 'answer') card.onclick = () => selectCard(card, type);
                container.appendChild(card);
            });
        }

        function selectCard(card, type) {
            if (card.classList.contains('matched')) return;

            if (type === 'korean') {
                if (selectedKorean) selectedKorean.classList.remove('selected');
                selectedKorean = card;
                card.classList.add('selected');
            } else {
                if (selectedEnglish) selectedEnglish.classList.remove('selected');
                selectedEnglish = card;
                card.classList.add('selected');
            }

            if (selectedKorean && selectedEnglish) checkPair();
        }

        function checkPair() {
            fetch('/api/check_pair', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    korean: selectedKorean.textContent,
                    english: selectedEnglish.textContent
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.correct) {
                    selectedKorean.classList.remove('selected');
                    selectedEnglish.classList.remove('selected');
                    selectedKorean.classList.add('matched');
                    selectedEnglish.classList.add('matched');
                    const answerCard = Array.from(document.querySelectorAll('#answer-cards .reveal-card'))
                        .find(c => c.textContent === selectedEnglish.textContent);
                    if (answerCard) answerCard.classList.add('matched');
                    correctCount++;
                    correctPairs.push({ korean: selectedKorean.textContent, english: selectedEnglish.textContent });
                    updateScore();
                    if (correctCount >= 5) updateCardSet();
                    if (correctCount >= 12) showReview();
                } else {
                    missed.push(selectedKorean.textContent);
                    selectedKorean.classList.add('error');
                    selectedEnglish.classList.add('error');
                    setTimeout(() => {
                        selectedKorean.classList.remove('error', 'selected');
                        selectedEnglish.classList.remove('error', 'selected');
                        selectedKorean = null;
                        selectedEnglish = null;
                    }, 500);
                }
            });
        }

        function updateScore() {
            document.getElementById('score').textContent = correctCount;
        }

        function updateCardSet() {
            if (correctPairs.length >= 5) {
                const toRemove = correctPairs.slice(0, 4); // First 4 correct pairs
                correctPairs = correctPairs.slice(4); // Keep the last one
                const slice = document.getElementById('slice').value;
                fetch(`/api/cards?slice=${slice}`)
                    .then(response => response.json())
                    .then(data => {
                        const newKorean = data.korean.slice(0, 4);
                        const newOrderedEnglish = data.ordered_english.slice(0, 4);
                        const newShuffledEnglish = data.shuffled_english.slice(0, 4);

                        toRemove.forEach(pair => {
                            const kCard = Array.from(document.querySelectorAll('#korean-cards .card'))
                                .find(c => c.textContent === pair.korean);
                            const eCard = Array.from(document.querySelectorAll('#english-cards .card'))
                                .find(c => c.textContent === pair.english);
                            const aCard = Array.from(document.querySelectorAll('#answer-cards .card'))
                                .find(c => c.textContent === pair.english);
                            if (kCard) kCard.remove();
                            if (eCard) eCard.remove();
                            if (aCard) aCard.remove();
                        });

                        const kContainer = document.getElementById('korean-cards');
                        const aContainer = document.getElementById('answer-cards');
                        const eContainer = document.getElementById('english-cards');
                        newKorean.forEach(item => {
                            const card = document.createElement('div');
                            card.className = 'card korean-card';
                            card.textContent = item;
                            card.dataset.korean = item;
                            card.onclick = () => selectCard(card, 'korean');
                            kContainer.appendChild(card);
                        });
                        newOrderedEnglish.forEach(item => {
                            const card = document.createElement('div');
                            card.className = 'card answer-card reveal-card';
                            card.textContent = item;
                            card.dataset.answer = item;
                            card.dataset.fulltext = item;
                            aContainer.appendChild(card);
                        });
                        newShuffledEnglish.forEach(item => {
                            const card = document.createElement('div');
                            card.className = 'card english-card';
                            card.textContent = item;
                            card.dataset.english = item;
                            card.dataset.fulltext = item;
                            card.onclick = () => selectCard(card, 'english');
                            eContainer.appendChild(card);
                        });
                    });
            }
        }

        function showReview() {
            if (missed.length > 0) {
                const missedList = document.getElementById('missed-list');
                missedList.innerHTML = '';
                missed.forEach(block => {
                    const li = document.createElement('li');
                    li.textContent = block;
                    missedList.appendChild(li);
                });
                document.getElementById('review').style.display = 'block';
            }
        }

        document.getElementById('restart-btn').addEventListener('click', loadCards);
        const revealBtn = document.getElementById('reveal-btn');
        revealBtn.addEventListener('mousedown', () => {
            document.querySelectorAll('.reveal-card:not(.matched)').forEach(card => {
                card.classList.add('revealed');
            });
        });
        revealBtn.addEventListener('mouseup', () => {
            document.querySelectorAll('.reveal-card:not(.matched)').forEach(card => {
                card.classList.remove('revealed');
            });
        });
        revealBtn.addEventListener('mouseleave', () => {
            document.querySelectorAll('.reveal-card:not(.matched)').forEach(card => {
                card.classList.remove('revealed');
            });
        });

        // Initial load
        loadCards();
    </script>
</body>
</html>
